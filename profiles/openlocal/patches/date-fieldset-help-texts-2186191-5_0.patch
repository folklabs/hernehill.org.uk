From eb17d24ad0d6ab737dd8da30b60a83125912f5a6 Mon Sep 17 00:00:00 2001
From: Juho Viitasalo <jiv_e@2603494.no-reply.drupal.org>
Date: Tue, 4 Feb 2014 00:25:41 +0200
Subject: [PATCH] Issue #2186191 by jiv_e: Date repeat removes the field's help
 text.

---
 date.theme        |  2 +-
 date_elements.inc | 15 +++++++--------
 2 files changed, 8 insertions(+), 9 deletions(-)

diff --git a/date.theme b/date.theme
index cc88e87..f8ced40 100644
--- a/date.theme
+++ b/date.theme
@@ -374,7 +374,7 @@ function theme_date_combo($variables) {
   $fieldset = array(
     '#title' => t($element['#title']) . ' ' . ($element['#delta'] > 0 ? intval($element['#delta'] + 1) : ''),
     '#value' => '',
-    '#description' => !empty($element['#fieldset_description']) ? $element['#fieldset_description'] : '',
+    '#description' => !empty($element['#description']) ? t($element['#description']) : '',
     '#attributes' => array(),
     '#children' => $element['#children'],
   );
diff --git a/date_elements.inc b/date_elements.inc
index 4303d13..d81733b 100644
--- a/date_elements.inc
+++ b/date_elements.inc
@@ -241,7 +241,7 @@ function date_default_value_part($item, $field, $instance, $langcode, $part = 'v
  * Process an individual date element.
  */
 function date_combo_element_process($element, &$form_state, $form) {
-    
+
   if (date_hidden_element($element)) {
     // A hidden value for a new entity that had its end date set to blank
     // will not get processed later to populate the end date, so set it here.
@@ -331,8 +331,11 @@ function date_combo_element_process($element, &$form_state, $form) {
     '#date_label_position' => $instance['widget']['settings']['label_position'],
     );
 
-  $description =  !empty($element['#description']) ? t($element['#description']) : '';
-  unset($element['#description']);
+  if(isset($element['show_repeat_settings']) && !empty($element['value']['#instance']['description'])) {
+    //Date repeat is a multiple value field. So the description is removed from the
+    //single element earlier. Let's get it back.
+    $element['#description'] = $element['value']['#instance']['description'];
+  }
 
   // Give this element the right type, using a Date API
   // or a Date Popup element type.
@@ -375,8 +378,7 @@ function date_combo_element_process($element, &$form_state, $form) {
     $element[$to_field]['#prefix'] = '';
     // Users with JS enabled will never see initially blank values for the end
     // date (see Drupal.date.EndDateHandler()), so hide the message for them.
-    $description .= '<span class="js-hide"> ' . t("Empty 'End date' values will use the 'Start date' values.") . '</span>';
-    $element['#fieldset_description'] = $description;
+    $element['#description'] .= '<span class="js-hide"> ' . t("Empty 'End date' values will use the 'Start date' values.") . '</span>';
     if ($field['settings']['todate'] == 'optional') {
       $element[$to_field]['#states'] = array(
         'visible' => array(
@@ -384,9 +386,6 @@ function date_combo_element_process($element, &$form_state, $form) {
       ));
     }
   }
-  else {
-    $element[$from_field]['#description'] = $description;
-  }
 
   // Create label for error messages that make sense in multiple values
   // and when the title field is left blank.
-- 
1.8.2

